%===============================================================================
% This file is based on the following source:
%
% ファイル名: master_ja_sample.tex
% 作成者：サイトウ リョウタ（2024年度山上研究室 修士修了）
% 作成日：2025年2月19日
% https://github.com/ryota-saito-coastal/LaTeXsample_for_Kyoto-u_civileng_mthesis
%===============================================================================

% --- 基本パッケージ ---
\usepackage{luatexja}
\usepackage{luatexja-fontspec}
\usepackage[haranoaji]{luatexja-preset}

\usepackage{amsmath,amssymb,amsthm}% 数式関連のパッケージ
\usepackage{empheq} % 数式に括弧
\usepackage{mathtools}
\mathtoolsset{showonlyrefs=true}
\usepackage[unicode=true,hypertexnames=false,setpagesize=false,colorlinks=true,urlcolor=blue,linkcolor=blue,citecolor=blue]{hyperref}
\usepackage{cleveref}
\input{./settings/cref.tex} 
\usepackage{mathtools}

\usepackage{physics}
\usepackage[ppl]{mathcomp}
\usepackage{bm}
\usepackage{siunitx}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{float}       % [H] オプション用
\usepackage{booktabs}    % 表の罫線（topruleなど）
\usepackage{xltabular}
\usepackage{makecell}
\usepackage{xcolor}
\usepackage{ifthen}
\usepackage{geometry}
\usepackage{setspace}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage{tocloft}
\usepackage{indentfirst} % 章の最初の段落も字下げ
\usepackage{bookmark}
\usepackage{caption}
\usepackage{enumitem}
\usepackage{url}
\usepackage{tabularx}   % For adjustable column widths
\usepackage{ragged2e}   % For better text alignment

% algorithm2e: アルゴリズムを書くためのパッケージ
\usepackage[ruled,vlined]{algorithm2e}
% ruled: 罫線を表示
% vlined: ブロックの縦線を表示
\SetKwComment{Comment}{// }{} 

\usepackage[colorinlistoftodos]{todonotes} % TODO用。Writing以外の思いついたEditingタスクを瞬時に外部化し、ワーキングメモリを解放
% --- 参考文献設定 (Biber + BibLaTeX) ---
% 従来の \usepackage{cite} や thebibliography環境 の代わり
\usepackage[backend=biber, style=phys, sorting=none]{biblatex} % style=numeric → style=physics

% --- 参考文献リストのスタイル設定 ---
% 1. 参考文献リスト内の行間を「1.0 (シングル)」に強制変更 ※ 全体の \linespread{2.5} をここだけ無効化
\AtBeginBibliography{\setstretch{1.0}} 
% 2. 項目ごとのフォントサイズを少し小さくする（任意） ※ 必要なければ \small を削除してください
% \renewcommand*{\bibfont}{\small}
% 3. 文献アイテム同士の間隔を詰める
\setlength{\bibitemsep}{2.5pt} % 項目間の余白 (0ptでも可)
\setlength{\bibparsep}{1.0pt}  % 項目内の段落間余白

% % 引用番号のスタイルを [1] から 1) に変更
% \DeclareFieldFormat{labelnumberwidth}{#1)}

% % 文中の引用 \cite{} を上付き文字にする設定
% \DeclareCiteCommand{\cite}[\mkbibsuperscript]
%   {\usebibmacro{cite:init}%
%    \usebibmacro{prenote}}
%   {\usebibmacro{citeindex}%
%    \printfield{labelnumber}\printtext{)}} % 閉じ括弧 ) を追加
%   {\multicitedelim}
%   {\usebibmacro{postnote}}

% 複数の引用をカンマ区切りにする
\renewcommand*{\multicitedelim}{\textsuperscript{,}}

% --- フォント設定 (LuaLaTeX用) ---
% 英数字フォント
\setmainfont{Times New Roman}[RawFeature={+palt, +kern}, LetterSpace=2.0]
\setsansfont{Arial}[RawFeature={+palt, +kern}, LetterSpace=1.5]
\setmonofont{Courier New}[RawFeature={+palt, +kern}, LetterSpace=1.0]

% 日本語フォント（必要に応じて有効化してください）
% \setmainjfont{MS Mincho}[RawFeature={+palt, +kern}, LetterSpace=12.5]
% \setsansjfont{MS Gothic}[RawFeature={+palt, +kern}, LetterSpace=10.0]
% \renewcommand{\bfseries}{\gtfamily}

% --- ページレイアウト ---
\geometry{left=20mm, right=20mm, top=25mm, bottom=25mm}
\setstretch{1.2} % 1.2倍行間

% --- キャプション等の日本語化 ---
\renewcommand{\figurename}{\normalfont\gtfamily 図}
\renewcommand{\tablename}{\normalfont\gtfamily 表}
\renewcommand{\contentsname}{\normalfont\gtfamily 目次}
\renewcommand{\thefigure}{\thechapter-\arabic{figure}}
\renewcommand{\thetable}{\thechapter-\arabic{table}}

% --- 見出しデザイン (titlesec) ---
\titleformat{\chapter}
    {\normalfont\fontsize{20pt}{24pt}\gtfamily}
    {第\hspace{2pt}\thechapter 章}
    {20pt}
    {\fontsize{20pt}{10pt}\selectfont}

\titleformat{\section}{\normalfont\fontsize{12pt}{12pt}\gtfamily}{\thesection}{1em}{}
\titleformat{\subsection}{\normalfont\fontsize{12pt}{12pt}\gtfamily}{\thesubsection}{1em}{}

% --- 目次設定 (tocloft) ---
\renewcommand{\cftchappresnum}{第}
\renewcommand{\cftchapaftersnum}{章\hspace{0.5em}}
\setlength{\cftchapnumwidth}{4.0em}

% --- ヘッダー・フッター ---
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0pt}

% --- 便利コマンド ---
\newcommand{\HRule}[1]{\rule{1\linewidth}{#1}}
\newcommand{\percent}{\%}
\newcommand{\figureref}[1]{図\ref{#1}}
\newcommand{\tableref}[1]{表\ref{#1}}



% --- TODO用コマンド ---
% 要修正：赤（論理の飛躍、間違いなど）
\newcommand{\fix}[1]{\todo[inline, color=red!40, bordercolor=red, size=\small]{#1}}
% 要確認・出典：青（事実確認、引用もと探し）
\newcommand{\checkref}[1]{\todo[inline, color=blue!30, bordercolor=blue, size=\small]{#1}}
% 表現・推敲：緑（英語の言い回し、日本語のニュアンス）
\newcommand{\rewrite}[1]{\todo[inline, color=green!40, bordercolor=green, size=\small]{#1}}
% 自分へのメモ：黄色（デフォルト）
\newcommand{\note}[1]{\todo[inline, size=\small]{#1}}
% 小林先生のコメント
\newcommand{\kobayashi}[1]{\todo[inline, color=gray!40, bordercolor=gray, size=\small]{#1}}


% --- 図
\newcommand{\IncludeThreeImages}[9][3cm]{% [デフォルト高さは3cm]
  \begin{figure}[htbp]
    \centering
    % --- 1枚目 ---
    \begin{subfigure}[t]{0.32\textwidth}
      \centering
      \includegraphics[height=#1, keepaspectratio]{#2}
      \caption{#3} % 自動で(a)が入ります
    \end{subfigure}
    \hfill
    % --- 2枚目 ---
    \begin{subfigure}[t]{0.32\textwidth}
      \centering
      \includegraphics[height=#1, keepaspectratio]{#4}
      \caption{#5}
    \end{subfigure}
    \hfill
    % --- 3枚目 ---
    \begin{subfigure}[t]{0.32\textwidth}
      \centering
      \includegraphics[height=#1, keepaspectratio]{#6}
      \caption{#7}
    \end{subfigure}
    % --- 全体設定 ---
    \caption{#8}
    \label{#9}
  \end{figure}
}
% \IncludeThreeImages[4cm]
%   {img1.jpg}{キャプション1}
%   {img2.jpg}{キャプション2}
%   {img3.jpg}{キャプション3}
%   {全体キャプション}
%   {fig:test}
\newcommand{\IncludeTwoImages}[7][4cm]{% [デフォルト高さは3cm]
  \begin{figure}[htbp]
    \centering
    % --- 1枚目 ---
    \begin{subfigure}[t]{0.45\textwidth}
      \centering
      \includegraphics[height=#1, keepaspectratio]{#2}
      \caption{#3} % 自動で(a)が入ります
    \end{subfigure}
    \hspace{0.5cm}
    % --- 2枚目 ---
    \begin{subfigure}[t]{0.45\textwidth}
      \centering
      \includegraphics[height=#1, keepaspectratio]{#4}
      \caption{#5}
    \end{subfigure}
    % --- 全体設定 ---
    \caption{#6}
    \label{#7}
  \end{figure}
}


% --- デバッグモード設定 (目に優しい黒背景) ---
% \submissionmode は main.tex で定義する
\newcommand{\debugnote}{
    \ifthenelse{\submissionmode=0}{
        \textbf{\textcolor{red}{\LARGE{REMOVE THIS COLOR SETTING FOR SUBMISSION!}}} \\
    }{}
}
% 設定反映ロジック
\AtBeginDocument{
    \ifthenelse{\submissionmode=0}{
        \pagecolor{black}
        \color{white}
    }{}
}

% --- 雑設定 ---]

\AtBeginDocument{\RenewCommandCopy\qty\SI} % siunitx と physics の競合回避 